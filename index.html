<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Estimativa</title>

<style>
    /* Vari√°veis de Cores - Tema Claro (Padr√£o) */
    :root {
        --bg-body: #f4f4f9;
        --bg-table: white;
        --bg-header: #0d6efd;
        --text-main: #333;
        --border-color: #ddd;
        --bg-est-row: #e0f7ff;
        --bg-pts-row: white;
        --bg-modal: white;
        --text-ranking-score: #333;
    }

    /* Vari√°veis de Cores - Tema Escuro */
    body.dark-theme {
        --bg-body: #121212;
        --bg-table: #1e1e1e;
        --bg-header: #0a4da3;
        --text-main: #e0e0e0;
        --border-color: #444;
        --bg-est-row: #1a3a4a;
        --bg-pts-row: #1e1e1e;
        --bg-modal: #2d2d2d;
        --text-ranking-score: #fff;
    }

    body {
        font-family: Arial, sans-serif;
        background: var(--bg-body);
        margin: 0;
        padding: 10px; 
        color: var(--text-main);
        transition: background 0.3s, color 0.3s;
    }
    
    .table-container {
        overflow: auto; 
        max-height: 80vh; 
        margin-bottom: 5px;
    }
    table {
        width: 100%; 
        min-width: fit-content;
        border-collapse: collapse;
        background: var(--bg-table);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        border-radius: 8px;
    }
    
    th, td {
        border: 1px solid var(--border-color);
        padding: 4px; 
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
    }
    
    td {
        z-index: 1; 
    }

    input {
        padding: 4px;
        text-align: center;
        border: 1px solid #aaa;
        border-radius: 4px;
        box-sizing: border-box;
        background: var(--bg-table);
        color: var(--text-main);
    }

    .botao-estimativa { 
        width: 30px; 
        padding: 2px;
        height: 35px;
        box-sizing: border-box;
        font-weight: bold;
        border: 1px solid #aaa;
        background-color: #deeafc;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.1s;
        color: #000; 
    }
	.botao-pontos { 
        width: 30px; 
        padding: 2px;
        height: 35px;
        box-sizing: border-box;
        font-weight: bold;
        border: 1px solid #aaa;
        background-color: #faf1ed;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.1s;
        color: #000; 
    }
    .botao-estimativa:hover, .botao-pontos:hover {
        background-color: #e0e0e0;
    }

    .celula-estimativa, .celula-pontos {
        position: relative; 
        padding: 2px;
    }

    .jogador input[type='text'] {
        width: 98px !important; 
    }
    
    th {
        background: var(--bg-header);
        color: white;
        font-weight: bold;
        position: sticky; 
        top: 0;
        z-index: 200; 
    }

    .linha-estimativa td {
        background-color: var(--bg-est-row); 
    }
    .linha-pontos td {
        background-color: var(--bg-pts-row); 
    }

    .jogador { 
        width: 110px; 
        font-weight: bold;
        position: sticky;
        left: 0;
        z-index: 101; 
    }
    
    td.tipo-col {
        position: sticky;
        left: 110px; 
        width: 60px; 
        font-weight: bold;
        z-index: 100; 
    }

    .linha-estimativa .jogador,
    .linha-estimativa .tipo-col {
        background-color: var(--bg-est-row) !important;
    }
    .linha-pontos .jogador,
    .linha-pontos .tipo-col {
        background-color: var(--bg-pts-row) !important; 
    }

    .table-container thead th:nth-child(1) {
        position: sticky;
        left: 0;
        z-index: 202;
        width: 110px; 
    }

    .table-container thead th:nth-child(2) {
        position: sticky;
        left: 110px; 
        background: var(--bg-header); 
        color: white;
        z-index: 201;
    }
    
    #selection-overlay, #ranking-overlay, #info-overlay {
        position: fixed; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7); 
        display: none; 
        justify-content: center;
        align-items: center;
        z-index: 9998; 
    }

    #selection-modal, #ranking-output, #info-output {
        padding: 15px;
        border: 2px solid #0d6efd;
        border-radius: 10px;
        background-color: var(--bg-modal);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        width: 90%; 
        max-width: 350px; 
        max-height: 80%; 
        overflow-y: auto;
        position: relative;
        animation: fadeIn 0.3s ease-out;
        color: var(--text-main);
    }
    
    #selection-modal {
        max-width: 250px; 
    }
    
    #selection-modal h3, #ranking-output h2, #info-output h2 {
        color: #0d6efd;
        text-align: center;
        margin-top: 0;
    }
    
    #selection-options {
        display: flex;
        flex-wrap: wrap; 
        gap: 10px;
        justify-content: center;
        margin-bottom: 10px;
    }

    #selection-options button {
        width: 50px; 
        padding: 10px 5px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: #f0f0f0;
        color: #333;
        cursor: pointer;
        margin: 0; 
        box-sizing: border-box;
    }
    
  #close-selection-button {
    display: block;
    width: 100%;
    margin-top: 15px;
    background: #717d84; 
    color: white;
    padding: 12px;
    font-size: 18px;
    border: none;
    border-radius: 12px; 
    cursor: pointer;
    font-weight: normal;
}

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    #ranking-output ul {
        list-style-type: none;
        padding: 0;
    }

    #ranking-output li {
        margin: 10px 0;
        padding: 8px;
        border-bottom: 1px solid var(--border-color);
        font-size: 1.1em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .rank-number {
        font-weight: bold;
        color: #0d6efd;
        min-width: 30px;
    }

    .rank-score {
        font-weight: bold;
        color: var(--text-ranking-score);
        min-width: 70px;
        text-align: right;
    }

    .rank-jogador {
        flex-grow: 1;
        text-align: left;
        margin: 0 10px;
    }

    .main-btn {
        margin-top: 5px; 
        padding: 8px 20px; 
        font-size: 16px;
        border: none;
        border-radius: 6px;
        background: #0d6efd;
        color: white;
        cursor: pointer;
    }

    .btn-reset {
        background: #dc3545;
        margin-left: 10px;
    }

    #close-button {
        display: block;
        width: 100%;
        margin-top: 15px;
        background: #dc3545;
        padding: 10px;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    /* √çcones no canto inferior direito */
    #info-icon, #theme-icon {
        position: fixed;
        bottom: 15px;
        width: 40px;
        height: 40px;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 40px;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        cursor: pointer;
        z-index: 10000;
        transition: transform 0.2s;
    }

    #info-icon {
        right: 15px;
        background-color: #0d6efd;
        font-size: 24px;
    }

    #theme-icon {
        right: 65px; /* Posicionado √† esquerda do info-icon */
        background-color: #333;
    }
    
    body.dark-theme #theme-icon {
        background-color: #f1c40f;
        color: #333;
    }

    #info-output {
        max-width: 300px;
        text-align: center;
    }

    #card-display {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-top: 15px;
    }

    .card {
        border: 1px solid #333;
        border-radius: 5px;
        background-color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        aspect-ratio: 2 / 3;
    }

    .suit {
        font-weight: bold;
        text-align: center;
        line-height: 1;
    }

    .red { color: #dc3545; }
    .black { color: #333; }

    #card-diamante, #card-espada, #card-copas, #card-paus { width: 80px; }
    #card-diamante .suit { font-size: 100px; }
    #card-espada .suit { font-size: 90px; }
    #card-copas .suit { font-size: 80px; }
    #card-paus .suit { font-size: 70px; }

    #card-values {
        margin-top: 15px;
        font-size: 0.9em;
        font-weight: bold;
        color: var(--text-main);
    }
</style>
</head>
<body>
<img src="titulo.png" style="width:100%;  height:auto;">

<div class="table-container">
    <table id="tabela">
        <thead>
            <tr>
                <th class="jogador fixed-col">Jogador</th>
                <th class="fixed-col">Tipo</th>
                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th>
                <th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th>
                <th>TOTAL</th>
            </tr>
        </thead>
        <tbody id="tabela-corpo">
            </tbody>
    </table>
</div>
<div style="width:100%; display:flex; justify-content:center;">
<button class="main-btn" onclick="mostrarRanking()" style="width:40%;" >Ranking</button>
<button class="main-btn btn-reset" onclick="resetarJogo()" style="width:40%;">Recome√ßar</button>

</div>
<div id="theme-icon" onclick="toggleTheme()" title="Alternar Tema">üåì</div>
<div id="info-icon" onclick="mostrarInfo()">!</div>

<div id="ranking-overlay">
    <div id="ranking-output"></div>
</div>

<div id="selection-overlay">
    <div id="selection-modal">
        <h3>Selecione o Valor</h3>
        <div id="selection-options"></div>
        <button type="button" id="close-selection-button" onclick="closeSelectionModal()">Fechar</button>
    </div>
</div>

<div id="info-overlay">
    <div id="info-output">
        <h2>ESTIMATIVA - V4</h2>
        <h3>Desenvolvido por IURI VOLNEY</h3>
        <h4>iuri.volney@gmail.com</h4>
        <div id="card-display">
            <div id="card-diamante" class="card"><span class="suit red">‚ô¶</span></div>
            <div id="card-espada" class="card"><span class="suit black">‚ô†</span></div>
            <div id="card-copas" class="card"><span class="suit red">‚ô•</span></div>
            <div id="card-paus" class="card"><span class="suit black">‚ô£</span></div>
        </div>
        <div id="card-values">
            A - K - Q - J - 10 - 9 - 8 - 7 - 6 - 5 - 4 - 3 - 2
        </div>
        <button class="main-btn" style="background:#6c757d; margin-top:20px;" onclick="fecharInfo()">Fechar</button>
    </div>
</div>

<script>
const COLUNAS = 12;
const JOGADORES = 6;
const STORAGE_KEY = 'estimativa_save_v3';
const THEME_KEY = 'estimativa_theme';

// Altern√¢ncia de Tema
function toggleTheme() {
    const isDark = document.body.classList.toggle('dark-theme');
    localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');
}

function loadTheme() {
    const savedTheme = localStorage.getItem(THEME_KEY);
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
    }
}

// Inicializa√ß√£o da Tabela
function renderizarTabela() {
    const tbody = document.getElementById('tabela-corpo');
    let html = '';
    for (let i = 0; i < JOGADORES; i++) {
        html += `<tr class="linha-estimativa" data-jogador-index="${i}"> 
            <td rowspan="2" class="jogador"><input type='text' oninput="saveData()" /></td>
            <td class="tipo-col">Estimativa</td> ${Array.from({length: COLUNAS}).map((_, col) => 
                `<td class="celula-estimativa" data-col="${col + 1}">
                    <button type="button" class="botao-estimativa" onclick="openEstimateSelector(this, ${col + 1})"></button>
                </td>` 
            ).join('')}
            <td rowspan="2" class="total">0</td>
        </tr>
        <tr class="linha-pontos" data-jogador-index="${i}"> 
            <td class="tipo-col">Ponto</td> ${Array.from({length: COLUNAS}).map((_, col) =>
                `<td class="celula-pontos" data-col="${col + 1}">
                    <button type="button" class="botao-pontos" onclick="openPontosSelector(this, ${col + 1})"></button>
                </td>`
            ).join('')}
        </tr>`;
    }
    tbody.innerHTML = html;
}

// Persist√™ncia de Dados
function saveData() {
    const data = { jogadors: [] };
    const rows = document.querySelectorAll('.linha-estimativa');
    
    rows.forEach((row, idx) => {
        const pRow = row.nextElementSibling;
        const jogadorData = {
            name: row.querySelector('.jogador input').value,
            estimates: Array.from(row.querySelectorAll('.botao-estimativa')).map(b => b.textContent),
            scores: Array.from(pRow.querySelectorAll('.botao-pontos')).map(b => b.textContent)
        };
        data.jogadors.push(jogadorData);
    });
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    atualizarTotais();
}

function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;
    
    const data = JSON.parse(saved);
    const rows = document.querySelectorAll('.linha-estimativa');
    
    data.jogadors.forEach((pData, idx) => {
        if (idx >= JOGADORES) return;
        const row = rows[idx];
        const pRow = row.nextElementSibling;
        
        row.querySelector('.jogador input').value = pData.name || "";
        
        const estBtns = row.querySelectorAll('.botao-estimativa');
        pData.estimates.forEach((val, i) => estBtns[i].textContent = val);
        
        const scoBtns = pRow.querySelectorAll('.botao-pontos');
        pData.scores.forEach((val, i) => scoBtns[i].textContent = val);
    });
    atualizarTotais();
}

function resetarJogo() {
    const confirmacao = prompt("Para zerar todos os dados, digite a palavra: APAGAR");
    if (confirmacao.toUpperCase().trim() === "APAGAR") {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    } else if (confirmacao !== null) {
        alert("Palavra incorreta. Os dados foram mantidos.");
    }
}

// Fun√ß√µes de L√≥gica do Jogo
function getConditionalPontosOptions(colIndex, estimativa) {
    if (isNaN(estimativa) || estimativa === null) return [];
    const N = colIndex;
    let options = [];
    if (estimativa === 0) {
        for(let i = 1; i <= N; i++) options.push(i);
        options.push(10);
    } else {
        for(let i = -estimativa; i <= -1; i++) options.push(i);
        for(let i = 1; i <= N - estimativa; i++) options.push(i);
        options.push(estimativa + 10);
    } 
    return Array.from(new Set(options)).sort((a, b) => a - b);
}

function atualizarTotais() {
    const rows = document.querySelectorAll('.linha-estimativa');
    rows.forEach(row => {
        const pRow = row.nextElementSibling;
        const scoreButtons = pRow.querySelectorAll('.botao-pontos');
        let soma = 0;
        scoreButtons.forEach(btn => {
            const val = parseInt(btn.textContent);
            if (!isNaN(val)) soma += val;
        });
        row.querySelector('.total').textContent = soma;
    });
}

function openSelector(button, options, title) {
    const overlay = document.getElementById('selection-overlay');
    const optionsContainer = document.getElementById('selection-options');
    document.querySelector('#selection-modal h3').textContent = title || 'Selecione';
    optionsContainer.innerHTML = '';
    
    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.onclick = () => {
            button.textContent = opt;
            if (button.classList.contains('botao-estimativa')) {
                const col = button.closest('.celula-estimativa').dataset.col;
                const pBtn = button.closest('.linha-estimativa').nextElementSibling.querySelector(`.celula-pontos[data-col="${col}"] .botao-pontos`);
                pBtn.textContent = "";
            }
            closeSelectionModal();
            saveData();
        };
        optionsContainer.appendChild(btn);
    });
    overlay.style.display = 'flex';
}

function openEstimateSelector(btn, max) {
    const opts = Array.from({length: max + 1}, (_, i) => i);
    openSelector(btn, opts, `Estimativa (0 a ${max})`);
}

function openPontosSelector(btn, col) {
    const estRow = btn.closest('.linha-pontos').previousElementSibling;
    const estVal = parseInt(estRow.querySelector(`.celula-estimativa[data-col="${col}"] button`).textContent);
    if (isNaN(estVal)) return alert("Selecione a ESTIMATIVA primeiro.");
    openSelector(btn, getConditionalPontosOptions(col, estVal), `Pontos (Est: ${estVal})`);
}

function mostrarRanking() {
    const jogadors = [];
    document.querySelectorAll('.linha-estimativa').forEach(row => {
        jogadors.push({
            nome: row.querySelector('.jogador input').value || "-",
            total: parseInt(row.querySelector('.total').textContent) || 0
        });
    });
    jogadors.sort((a, b) => b.total - a.total);

    let html = '<h2>üèÜRanking EstimativaüèÜ</h2><ul>' + jogadors.map((p, i) => 
        `<li><span class="rank-number">${i+1}¬∫</span><span class="rank-jogador">${p.nome}</span><span class="rank-score">${p.total} pts</span></li>`
    ).join('') + '</ul><button id="close-button" onclick="fecharRanking()">Fechar</button>';
    
    document.getElementById('ranking-output').innerHTML = html;
    document.getElementById('ranking-overlay').style.display = 'flex';
}

// Utils e Eventos
function closeSelectionModal() { document.getElementById('selection-overlay').style.display = 'none'; }
function fecharRanking() { document.getElementById('ranking-overlay').style.display = 'none'; }
function mostrarInfo() { document.getElementById('info-overlay').style.display = 'flex'; }
function fecharInfo() { document.getElementById('info-overlay').style.display = 'none'; }

window.addEventListener('beforeunload', (e) => { e.preventDefault(); e.returnValue = ''; });

// Start
loadTheme();
renderizarTabela();
loadData();

</script>
</body>
</html>
